---
title: "Shock and awe with R"
output:
  html_document:
    toc: yes
    toc_float: yes
  html_notebook:
    toc: yes
    toc_float: yes
---
[<<BACK](https://remi-daigle.github.io/2017-CHONe-Data/)

(Remi/David)

<!--

library(rmarkdown)
render(input = 'shocknawe.rmd', 'html_document')

-->



<!-- ## Structure of document

Get people acquainted with existing possibilities in R from environmental point of view and oceanographic point of view

Structure for shock and awe portion 1.
Ecologically describe a study area from available open source data

1. Define study area
2.

- SDM
- Species interactions
- Environmental data
- Go look at ropensci
- wordcloud2

4. How about it's phylogeny?

    install.package('brranching')


Now that we have a pretty thorough description of the species, what else could we find out. How about known occurrence in our study area


How about fisheries activity?
install.package('rfisheries') -->

<!--
setwd('/Users/davidbeauchesne/dropbox/phd/misc/2017-chone-data/2017-chone-data/')
-->

```{r, message=FALSE}
library(sf)
library(marmap)
library(raster)
library(tidyverse)
library(ggplot2)
```

# IMAGINE!

Let's imagine that you are interested in a species in a given area and wish to know as much as possible about it. But, you can't go out in the field because funding is running short. What you do have, however, is a certain knowledge of the tools that are available to you and you are wondering how far they can take you. Let's find out.

## Defining species and area of interest

```{r, params}
    # Let's select Atlantic cod as our species of interest
    sp <- 'Gadus morhua'

    # And the gulf of St. Lawrence as our study area
    #define the corners
    latmax <- 52.01312
    latmin <- 45.52399
    lonmax <- -55.73636
    lonmin <- -71.06333
    #
    # latmax <- 46.25
    # latmin <- 45.5
    # lonmax <- -61.25
    # lonmin <- -62.25
```

## Describe your species

### Fishbase <!-- and Reol? -->

We'll start with a description of the species. First, let's see what [fishbase](http://www.fishbase.ca/) has to offer. This online data repository, along with [sealifebase](http://www.sealifebase.org/), contains a lot of information on marine and aquatic species all over the world and is accessible through the `package [rfishbase](https://github.com/ropensci/rfishbase)`

<!-- Reol, install.packages('reol') -->

```{r, ecology, eval = FALSE}
    # Let's have a look at the information available our species ecology
    ecol <- rfishbase::ecology(sp)
    ecol <- cbind(colnames(ecol), t(ecol))
    rownames(ecol) <- NULL

    knitr::kable(ecol, col.names = c('Descriptors', 'Attributes'))
```

### Taxize

We can also get it's taxonomy rather easily. The package [taxize](https://ropensci.org/tutorials/taxize_tutorial.html) allows you to extract and validate, among other things, the taxonomy of millions of species by accessing an important number of online databases accessible through their Application program interface (API).

- Encyclopedia of Life (EOL) eol
- axonomic Name Resolution Service tnrs
- Integrated Taxonomic Information Service (ITIS) itis
- Global Names Resolver (from EOL/GBIF) gnr
- Global Names Index (from EOL/GBIF)
- IUCN Red List
- Tropicos (from Missouri Botanical Garden)
- Theplantlist.org
- Catalogue of Life
- National Center for Biotechnology Information
- CANADENSYS Vascan name search API
- International Plant Names Index (IPNI)
- World Register of Marine Species (WoRMS)
- Barcode of Life Data Systems (BOLD)
- Pan-European Species directories Infrastructure (PESI)
- Mycobank
- National Biodiversity Network (UK)
- Index Fungorum
- EU BON
- Index of Names (ION)
- Open Tree of Life (TOL)
- World Register of Marine Species (WoRMS)
- NatureServe

```{r, taxonomy}
    # Start by exporting the taxonomy of our species
        taxo <- taxize::classification(sp, db = 'worms', verbose = FALSE)
        taxo[[1]]

    # We can also extract the common or scientific names using sci2comm() & comm2sci(), respectively.
        taxize::sci2comm(sp, db = 'itis')

    # Or find out whether there are other names under which the species is known
        taxize::synonyms(sp, db = 'itis')

    # Another really interesting feature is to extract all known species at a given taxonomic scale.
    # Let's take the genus level and see the first 20 species that are part of that genus on the itis database
        taxize::children(strsplit(sp, ' ')[[1]][1], db = 'itis')[[1]]
```

### GloBI

How about extracting all known preys and predators of the species of interest? The [Global Biotic Interactions](http://globalbioticinteractions.org) web platform contains thousands of empirical binary interactions for multiple types of interactions, all over the world, and is easily accessible using the package [rglobi](https://github.com/ropensci/rglobi).

```{r, trophic, eval = FALSE}
    # There are multiple types of interactions available on GloBI
        rglobi::get_interaction_types()

    # For now let's focus on predator-prey interactions
        prey <- rglobi::get_prey_of(sp)$target_taxon_name
        pred <- rglobi::get_predators_of(sp)$target_taxon_name
        prey
        pred
```

<!-- Add d3 object or igraph object? -->

## Make your search spatially explicit

### Get data from OBIS

OBIS is the [Ocean Biogeographic Information System](http://www.iobis.org/) and their vision is: "To be the most comprehensive gateway to the worldâ€™s ocean biodiversity and biogeographic data and information required to address pressing coastal and world ocean concerns."

 We can get access to their HUGE database through the excellent `robis` package by [ropensci](https://ropensci.org/) (unsurprisingly, they also have other great open science R packages, from which this whole section is highly inspired)


```{r,eval=FALSE}
sf::st_as_text(bb$geometry)
OBIS <- robis::occurrence(scientificname = sp, geometry=st_as_text(bb$geometry), startdate = as.Date("2010-01-01"), enddate = as.Date("2017-01-01"))
write.csv(OBIS,'obis.csv',row.names = FALSE)
```

### Visualize data

We can easily visualize the data...

```{r, OBISPlot, eval = FALSE}
OBIS <- read.csv("obis.csv")
plot(OBIS[,c("decimalLongitude", "decimalLatitude")])
```

... but the aesthetics could be much better!

## Plot your study site
### Define site map limits
Let's start by defining a bounding box for your study site:

```{r, bounding box, eval = FALSE}
#create a matrix
bbmat <- cbind(
            c(lonmin,lonmax,lonmax,lonmin,lonmin),
            c(latmin,latmin,latmax,latmax,latmin)
        )
# make the matrix a 'simple features' polygon
bbsf <- st_polygon(list(bbmat))
# and let's give it information about the projection:
bbsfc <- st_sfc(bbsf,crs="+proj=longlat +datum=WGS84")
# finally, let's make it a simple features data.frame
bb <- st_sf(name="Study Site",geometry=bbsfc)
str(bb)

# plot it!
ggplot(bb) + geom_sf()
```

### Add a basemap!

There are many ways to add a basemap in R

#### marmap package

```{r,marmap, eval = FALSE}
bathymetry <- getNOAA.bathy(lonmin,lonmax,latmin,latmax,resolution=1,keep=TRUE)
plot.bathy(bathymetry,image=T,drawlabels=TRUE)

blues <- colorRampPalette(c("darkblue", "lightblue1"))
greys <- colorRampPalette(c(grey(0.4),grey(0.99)))

plot.bathy(bathymetry,
           image = TRUE,
           land = TRUE,
           n=0,
           bpal = list(c(0, max(bathymetry), greys(100)),
                       c(min(bathymetry), 0, blues(100))))

# this is a 'bathy' object and you could plot it as is with the tools provided in marmap, but to keep things 'simple' I'm going to convert to sf. There is no direct method yet, so... don't judge me!
# convert from bathy to raster to 'sp' polygon to simple features
# bathypoly <- marmap::as.raster(bathymetry) %>%
    # rasterToPolygons() %>% st_as_sf
bathyras <- fortify.bathy(bathymetry)

bathyras$z[bathyras$z>0] <- NA

ggplot() +
    geom_raster(data=bathyras,aes(x=x,y=y,fill=z))+
    geom_sf(data=bb,fill="transparent",colour='black')
```


```{r, eval = FALSE}
# Canada <- getData('GADM', country="CAN", level=1) %>%
#     st_as_sf() %>%
#     filter(NAME_1=="Nova Scotia"|
#                NAME_1=="Prince Edward Island"|
#                NAME_1=="New Brunswick")
# ggplot() +
#     geom_sf(data=Canada,aes(fill=NAME_1))

x=0.2
ggplot() +
    geom_raster(data=bathyras,aes(x=x,y=y,fill=z))+
    geom_sf(data=bb,fill="transparent",colour='yellow',size=2)+
    geom_sf(data=Canada,fill='grey40')+
    coord_sf(xlim = c(lonmin-x,lonmax+x),
             ylim = c(latmin-x,latmax+x),
             expand = F)

```

## Overlay your species occurrences over the base map

You can now overlay your species occurrences on your base map!

```{r, eval = FALSE}
OBIS <- st_as_sf(OBIS,
                 coords = c("decimalLongitude", "decimalLatitude"),
                 crs="+proj=longlat +datum=WGS84",
                 remove=FALSE) %>%
    filter(!is.na(species))


    ggplot(OBIS) +
        geom_raster(data=bathyras,aes(x=x,y=y,fill=z))+
        geom_sf(data=bb,fill="transparent",colour='yellow',size=2)+
        # geom_sf(data=Canada,fill='grey40')+
        geom_point(data=OBIS,aes(x=decimalLongitude,y=decimalLatitude))+
        facet_wrap(~phylum)+
        coord_sf(xlim = c(lonmin-x,lonmax+x),
                 ylim = c(latmin-x,latmax+x),
                 expand = F)
```

## Environmental variables

There are also multiple resources to access environmental data. As seen before, we can easily access bathymetry data using the marmap package. Other environmental data can also be accessed using other packages like `raster` for terrestrial climatic data and `rnoaa`

### Extract sea surface temperature (SST)

```{r, NOAA, eval = TRUE}
    # Bear with us, for simplicity's sake we will only take one year of data for one month, knowing very well that this does not make sense ecologically!
    # Eventually use apply() to load multiple datasets and create rasterStack
        # An exemple with sea ice
            # urls <- seaiceeurls(mo='Apr', pole='N')[1:10]
            # out <- lapply(urls, seaice)
            # names(out) <- seq(1979,1988,1)
            # df <- ldply(out)
            # library('ggplot2')
            # ggplot(df, aes(long, lat, group=group)) +
            # geom_polygon(fill="steelblue") +
            # theme_ice() +
            # facet_wrap(~ .id)

        sst.nc <- rnoaa::ersst(2010, 8, overwrite = TRUE)
        sst <- raster(sst.nc$filename)

    # Transform rasterLayer as a data.frame
        sst.spdf <- as(sst, "SpatialPixelsDataFrame")
        sst.df <- as.data.frame(sst.spdf)
        colnames(sst.df) <- c('sst','x','y')

    # Plot newly acquired data!
        ggplot(sst.df, aes(x=x, y=y)) +
            geom_tile(aes(x=x,y=y,fill=sst)) +
            coord_equal()

```

## Species distribution models

Now what we can do once we have species occurrence data and environmental variables are species distribution models (SDMs). There are multiple ways and packages to perform SDMs and this [vignette](https://cran.r-project.org/web/packages/dismo/vignettes/sdm.pdf) provides an extensive overview of the different methods available. For this workshop, we will be using the `package biomod2`, which implements most of the methods presented in the vignette.


### Build a study area grid

The first step is to build a regular grid covering the study area




## Community level analyses

One of the usual challenges in ecology is to perform analyses at the community scale often due to the difficulty of sampling multiple species in a single system. However, OBIS once again gives us the opportunity to access multiple species occurrences. Let's go back to OBIS and extract every available data in our system.

```{r, multi species OBIS, eval = FALSE}
    # Load all known species occurrences from our area of interest
        multiOBIS <- robis::occurrence(geometry=st_as_text(bb$geometry), startdate = as.Date("2010-01-01"), enddate = as.Date("2017-01-01"), fields = c("species", "yearcollected","decimalLongitude", "decimalLatitude"))
        multiOBIS <- multiOBIS[!is.na(multiOBIS[,'species']), ] # remove species == NA

    # Select species for which there is at least n observations
        n = 50
        spOK <- names(which(table(multiOBIS[,'species']) >= n)) # id of species with at least n observations
        multiOBIS <- multiOBIS[multiOBIS[, 'species'] %in% spOK, ] # Subset of multiOBIS data with species with at least n observations
        multiOBIS[,'species'] <- as.factor(multiOBIS[,'species'])
        multiOBIS[,'yearcollected'] <- as.factor(multiOBIS[,'yearcollected'])
        write.csv(multiOBIS,'multiOBIS.csv',row.names = FALSE)
```

```{r, multiOBISPlot, eval = T}
multiOBIS <- read.csv("multiOBIS.csv")
str(multiOBIS)


multiOBIS <- st_as_sf(multiOBIS,
                 coords = c("decimalLongitude", "decimalLatitude"),
                 crs="+proj=longlat +datum=WGS84",
                 remove=FALSE) %>%
    filter(!is.na(species))

    ggplot(multiOBIS) +
        geom_raster(data=bathyras,aes(x=x,y=y,fill=z))+
        geom_sf(data=bb,fill="transparent",colour='yellow',size=2)+
        geom_point(data=multiOBIS,aes(x=decimalLongitude,y=decimalLatitude))+
        coord_sf(xlim = c(lonmin-x,lonmax+x),
                 ylim = c(latmin-x,latmax+x),
                 expand = F)
```





[<<BACK](https://remi-daigle.github.io/2017-CHONe-Data/)
